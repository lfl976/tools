<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ­Œè¯åŒæ­¥ + æ³¨éŸ³ï¼ˆæ‡’åŠ è½½ï¼‰</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: auto;
        padding: 2rem;
      }

      #lyrics {
        position: relative;
        height: 300px;
        overflow-y: auto;
        border: 1px solid #ccc;
        padding: 1rem;
        line-height: 2;
        white-space: pre-wrap;
      }

      .line {
        transition: color 0.2s;
      }

      .active {
        color: #ff4081;
        font-weight: bold;
      }

      .upload-group {
        margin-bottom: 1rem;
      }

      ruby {
        font-size: 1.1em;
      }

      rt {
        font-size: 0.6em;
        color: #666;
      }

      #toggleWrapper {
        margin-bottom: 1rem;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ æ­Œè¯åŒæ­¥ + æ—¥è¯­æ³¨éŸ³</h1>

    <div class="upload-group">
      <label
        >ä¸Šä¼  MP3 éŸ³é¢‘:
        <input type="file" id="mp3Input" accept="audio/mp3,audio/mp4" />
      </label>
    </div>

    <div class="upload-group">
      <label
        >ä¸Šä¼  LRC æ­Œè¯:
        <input type="file" id="lrcInput" accept=".lrc,.txt" />
      </label>
    </div>

    <div class="upload-group">
      <button id="loadDemo">ğŸµ åŠ è½½ç¤ºä¾‹æ­Œæ›²</button>
    </div>

    <div id="toggleWrapper">
      <label>
        <input type="checkbox" id="toggleFurigana" />
        æ˜¾ç¤ºæ—¥æ–‡å‡åæ³¨éŸ³
      </label>
    </div>

    <audio id="audio" controls style="width: 100%; margin-bottom: 1rem"></audio>

    <div id="lyrics">è¯·ä¸Šä¼ æ­Œè¯æ–‡ä»¶ (.lrc)</div>

    <script>
      const audio = document.getElementById('audio');
      const lyricsContainer = document.getElementById('lyrics');
      const toggleFurigana = document.getElementById('toggleFurigana');
      let lyrics = [];
      let furiganaLoaded = false; // âœ… æ³¨éŸ³æ˜¯å¦å·²åŠ è½½

      // è§£æ LRC
      const parseLyrics = (text) => {
        return text
          .split('\n')
          .map((line) => {
            const match = line.match(/\[(\d+):(\d+(?:\.\d+)?)\](.*)/);
            if (!match) return null;
            const [, min, sec, lyric] = match;
            return {
              time: parseInt(min) * 60 + parseFloat(sec),
              text: lyric.trim(),
              furiganaHtml: '',
            };
          })
          .filter(Boolean);
      };

      // è°ƒç”¨ API è·å–æ³¨éŸ³
      async function fetchFurigana(sentences) {
        const res = await fetch('https://kanji2kana-service.vercel.app/batch_tokenize', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sentences }),
        });
        const data = await res.json();
        return data.results;
      }

      // è½¬æ¢ä¸º ruby æ ‡ç­¾
      function buildRubyLine(tokens) {
        return tokens
          .map((token) => {
            const { surface, kana } = token;
            if (kana && kana !== surface) {
              return `<ruby>${surface}<rt>${kana}</rt></ruby>`;
            } else {
              return surface;
            }
          })
          .join('');
      }

      // æ¸²æŸ“æ­Œè¯ï¼ˆæ ¹æ®æ˜¯å¦æ˜¾ç¤ºæ³¨éŸ³ï¼‰
      const renderLyrics = () => {
        const useFurigana = toggleFurigana.checked;
        lyricsContainer.innerHTML = '';
        lyrics.forEach((line, i) => {
          const div = document.createElement('div');
          div.className = 'line';
          div.id = `line-${i}`;
          div.innerHTML = useFurigana && furiganaLoaded ? line.furiganaHtml : line.text;
          lyricsContainer.appendChild(div);
        });
      };

      // å¤„ç†æ³¨éŸ³å¼€å…³ç‚¹å‡»
      toggleFurigana.addEventListener('change', async () => {
        if (toggleFurigana.checked && !furiganaLoaded) {
          try {
            const lines = lyrics.map((l) => l.text);
            const results = await fetchFurigana(lines);
            results.forEach((tokens, idx) => {
              lyrics[idx].furiganaHtml = buildRubyLine(tokens);
            });
            furiganaLoaded = true;
          } catch (err) {
            alert('æ³¨éŸ³æ¥å£è¯·æ±‚å¤±è´¥');
            toggleFurigana.checked = false;
            return;
          }
        }
        renderLyrics(); // ä¸ç®¡åŠ è½½æ²¡åŠ è½½ï¼Œåˆ‡æ¢éƒ½é‡æ–°æ¸²æŸ“
      });

      // é«˜äº®æ­Œè¯è¡Œ
      audio.addEventListener('timeupdate', () => {
        const currentTime = audio.currentTime;
        let currentIndex = lyrics.findIndex((line, i) => {
          const next = lyrics[i + 1];
          return currentTime >= line.time && (!next || currentTime < next.time);
        });

        document.querySelectorAll('.line').forEach((el) => el.classList.remove('active'));

        if (currentIndex >= 0) {
          const currentLine = document.getElementById(`line-${currentIndex}`);
          currentLine.classList.add('active');
          const top = currentLine.offsetTop - lyricsContainer.clientHeight / 2;
          lyricsContainer.scrollTo({ top, behavior: 'smooth' });
        }
      });

      // ä¸Šä¼  MP3 éŸ³é¢‘
      document.getElementById('mp3Input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          audio.src = URL.createObjectURL(file);
        }
      });

      // ä¸Šä¼ æ­Œè¯
      document.getElementById('lrcInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = async () => {
            lyrics = parseLyrics(reader.result);
            furiganaLoaded = false; // âœ… æ¸…é™¤æ³¨éŸ³ç¼“å­˜
            renderLyrics();
          };
          reader.readAsText(file, 'utf-8');
        }
      });

      document.getElementById('loadDemo').addEventListener('click', async () => {
        const audioPath = './wasureji-no-kotonoha.mp4';
        const lrcPath = './wasureji-no-kotonoha.lrc';

        // è®¾ç½®éŸ³é¢‘æº
        audio.src = audioPath;
        audio.load();

        try {
          const response = await fetch(lrcPath);
          const text = await response.text();
          lyrics = parseLyrics(text);
          furiganaLoaded = false;
          renderLyrics();
        } catch (err) {
          alert('åŠ è½½æ­Œè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®');
        }
      });
    </script>
  </body>
</html>
